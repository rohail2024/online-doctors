<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Online Doctors Main</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #87CEEB;
      display: flex;
      flex-direction: column;
      height: 100vh;
      margin: 0;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      background-color: #1877f2;
      color: white;
    }
    .profile, .settings {
      display: flex;
      align-items: center;
    }
    .profile img {
      border-radius: 50%;
      width: 40px;
      height: 40px;
      margin-right: 10px;
    }
    #chatContainer {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
      background-color: #f0f0f0;
    }
    .message {
      margin: 10px 0;
    }
    .message.sent {
      text-align: right;
    }
    .message.received {
      text-align: left;
    }
    .footer {
      display: flex;
      align-items: center;
      padding: 10px;
      background-color: white;
    }
    .footer input {
      flex: 1;
      padding: 10px;
      margin-right: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .footer button {
      padding: 10px;
      background-color: #1877f2;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>Welcome to Online Doctors</h1>
    <div class="profile">
      <img id="profilePicture" src="" alt="Profile Picture" />
      <span id="profileName"></span>
      <button id="logoutButton">Logout</button>
    </div>
    <div class="settings">
      <label for="themeSelect">Theme:</label>
      <select id="themeSelect">
        <option value="light">Light</option>
        <option value="dark">Dark</option>
        <option value="bright">Bright</option>
      </select>
    </div>
  </div>
  <div id="chatContainer"></div>
  <div class="footer">
    <input type="text" id="messageInput" placeholder="Type your message" />
    <button class="emoji-button">ðŸ˜Š</button>
    <button id="sendMessageButton">Send</button>
  </div>

  <!-- Import Firebase SDKs and EmojiButton -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.9.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.9.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/9.9.1/firebase-firestore.js";
    import EmojiButton from 'https://cdn.jsdelivr.net/npm/@joeattardi/emoji-button@4.6.2/dist/emoji-button.js';

    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCSxmdDMPW8uOoeExuauRpQtSkavJK2LWE",
      authDomain: "online-doctors-4u.firebaseapp.com",
      projectId: "online-doctors-4u",
      storageBucket: "online-doctors-4u.appspot.com",
      messagingSenderId: "479784655731",
      appId: "1:479784655731:web:f856fa82e896ff76c28306",
      measurementId: "G-BMBQ0BJVMK"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Emoji Picker
    const picker = new EmojiButton();
    const trigger = document.querySelector('.emoji-button');
    picker.on('emoji', emoji => {
      document.querySelector('#messageInput').value += emoji;
    });
    trigger.addEventListener('click', () => picker.togglePicker(trigger));

    // Check Auth State
    onAuthStateChanged(auth, (user) => {
      if (user) {
        // User is signed in
        displayMessages();
        document.getElementById('sendMessageButton').addEventListener('click', () => sendMessage(user));
        document.getElementById('messageInput').addEventListener('keypress', (e) => {
          if (e.key === 'Enter' || e.keyCode === 13) {
            e.preventDefault();  // Prevent default behavior
            sendMessage(user);
          }
        });
        document.getElementById('themeSelect').addEventListener('change', loadTheme);
        document.getElementById('logoutButton').addEventListener('click', () => signOut(auth).then(() => {
          window.location.href = "index.html";
        }));
        // Add user profile and settings
        displayUserProfile(user);
      } else {
        // No user is signed in
        window.location.href = "index.html";
      }
    });

    // Send Message
    async function sendMessage(user) {
      const messageInput = document.getElementById('messageInput');
      if (messageInput.value.trim() !== "") {
        await addDoc(collection(db, "messages"), {
          text: messageInput.value,
          uid: user.uid,
          timestamp: new Date(),
          displayName: user.displayName
        });
        messageInput.value = "";  // Clear input field after sending
      }
    }

    // Display Messages
    function displayMessages() {
      const q = query(collection(db, "messages"), orderBy("timestamp"));
      const chatContainer = document.getElementById('chatContainer');
      onSnapshot(q, (snapshot) => {
        chatContainer.innerHTML = "";  // Clear existing messages
        snapshot.forEach((doc) => {
          const message = doc.data();
          const messageElement = document.createElement('div');
          messageElement.classList.add('message');
          messageElement.classList.add(message.uid === auth.currentUser.uid ? 'sent' : 'received');
          messageElement.innerHTML = `
            <div class="text">
              <strong>${message.displayName}:</strong> ${message.text}
            </div>
          `;
          chatContainer.appendChild(messageElement);
          chatContainer.scrollTop = chatContainer.scrollHeight;  // Scroll to bottom
        });
      });
    }

    // Display User Profile
    function displayUserProfile(user) {
      document.getElementById('profileName').textContent = user.displayName;
      document.getElementById('profilePicture').src = user.photoURL || '';
    }

    // Load Theme
    function loadTheme() {
      const theme = document.getElementById('themeSelect').value;
      if (theme === 'dark') {
        document.body.style.backgroundColor = '#333';
        document.body.style.color = '#fff';
      } else if (theme === 'bright') {
        document.body.style.backgroundColor = '#fff';
        document.body.style.color = '#000';
      } else {
        document.body.style.backgroundColor = '#87CEEB';
        document.body.style.color = '#000';
      }
    }
  </script>
</body>
</html>
