<!-- Import Firebase SDKs -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.9.1/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.9.1/firebase-analytics.js";
  import { getAuth, GoogleAuthProvider, createUserWithEmailAndPassword, signInWithPopup, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.9.1/firebase-auth.js";
  import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/9.9.1/firebase-firestore.js";

  // Firebase Configuration
  const firebaseConfig = {
    apiKey: "AIzaSyCSxmdDMPW8uOoeExuauRpQtSkavJK2LWE",
    authDomain: "online-doctors-4u.firebaseapp.com",
    projectId: "online-doctors-4u",
    storageBucket: "online-doctors-4u.appspot.com",
    messagingSenderId: "479784655731",
    appId: "1:479784655731:web:f856fa82e896ff76c28306",
    measurementId: "G-BMBQ0BJVMK"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
  const db = getFirestore(app);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();

  // Google Sign-In Function
  function googleSignIn() {
    signInWithPopup(auth, provider)
      .then((result) => {
        const user = result.user;
        console.log("User Info:", user);
        alert(`Welcome, ${user.displayName}`);
        storeUserData(user);  // Call function to store user data
        updateUserUI(user);  // Call function to update the UI
        window.location.href = "main.html";  // Redirect to main page
      })
      .catch((error) => {
        const errorCode = error.code;
        const errorMessage = error.message;
        console.error("Error during sign-in:", errorCode, errorMessage);
        displayErrorMessage(errorMessage);  // Display error message
      });
  }

  // Email/Password Sign-In Function
  function emailPasswordSignIn() {
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    if (!validateEmail(email)) {
      displayErrorMessage("Please enter a valid email address.");
      return;
    }
    signInWithEmailAndPassword(auth, email, password)
      .then((result) => {
        const user = result.user;
        console.log("User Info:", user);
        alert(`Welcome, ${user.email}`);
        window.location.href = "main.html";  // Redirect to main page
      })
      .catch((error) => {
        const errorCode = error.code;
        const errorMessage = error.message;
        console.error("Error during sign-in:", errorCode, errorMessage);
        displayErrorMessage(errorMessage);  // Display error message
      });
  }

  // Email/Password Registration Function
  function emailPasswordRegister() {
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    if (!validateEmail(email)) {
      displayErrorMessage("Please enter a valid email address.");
      return;
    }
    createUserWithEmailAndPassword(auth, email, password)
      .then((result) => {
        const user = result.user;
        console.log("User Info:", user);
        alert(`Registration successful. Welcome, ${user.email}`);
        storeUserData(user);  // Call function to store user data
        window.location.href = "main.html";  // Redirect to main page
      })
      .catch((error) => {
        const errorCode = error.code;
        const errorMessage = error.message;
        console.error("Error during registration:", errorCode, errorMessage);
        displayErrorMessage(errorMessage);  // Display error message
      });
  }

  // Validate Email Function
  function validateEmail(email) {
    const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return re.test(email);
  }

  // Store User Data
  function storeUserData(user) {
    const userRef = doc(db, "users", user.uid);
    setDoc(userRef, {
      name: user.displayName || '',
      email: user.email,
      profilePicture: user.photoURL || ''
    })
    .then(() => {
      console.log("User data saved successfully.");
    })
    .catch((error) => {
      console.error("Error saving user data:", error);
    });
  }

  // Update User Interface
  function updateUserUI(user) {
    document.getElementById('userInfo').style.display = 'block';
    document.getElementById('userName').textContent = `Welcome, ${user.displayName || ''}`;
    document.getElementById('userEmail').textContent = user.email;
    document.getElementById('userProfilePicture').src = user.photoURL || '';
  }

  // Display Error Message
  function displayErrorMessage(message) {
    const errorMessageElement = document.getElementById('errorMessage');
    errorMessageElement.textContent = message;
  }

  // Add event listeners to buttons
  document.getElementById('googleSignInButton').addEventListener('click', googleSignIn);
  document.getElementById('loginButton').addEventListener('click', emailPasswordSignIn);
  document.getElementById('registerButton').addEventListener('click', emailPasswordRegister);
</script>
